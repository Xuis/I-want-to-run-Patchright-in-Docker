name: scheduled-check-and-build

# Run every 4 hours + allow manual trigger
on:
  schedule:
    - cron: '0 */4 * * *'   # every 4 hours
  workflow_dispatch:

permissions:
  contents: write     # so the workflow can update the .last_patchright_release file
  packages: write     # allow pushing to GHCR via GITHUB_TOKEN

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: Kaliiiiiiiiii-Vinyzu
      UPSTREAM_REPO: patchright
      IMAGE_NAME: patchright

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Get latest upstream Patchright release tag
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo = process.env.UPSTREAM_REPO;
            try {
              const release = await github.rest.repos.getLatestRelease({ owner, repo });
              const tag = release.data.tag_name || release.data.name || "";
              core.setOutput("tag", tag);
            } catch (err) {
              // If upstream has no releases, fallback to empty tag
              core.setOutput("tag", "");
            }

      - name: Read previous stored release tag
        id: read_prev
        run: |
          echo "prev=$(cat .last_patchright_release 2>/dev/null || true)" >> $GITHUB_OUTPUT

      # Only run build + push if tags differ
      - name: Login to GitHub Container Registry (ghcr.io)
        if: ${{ steps.get_release.outputs.tag != steps.read_prev.outputs.prev }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ toLower(github.repository_owner) }}/patchright:${{ steps.get_release.outputs.tag }}
            ghcr.io/${{ toLower(github.repository_owner) }}/patchright:latest


      - name: Update .last_patchright_release and push
        if: ${{ steps.get_release.outputs.tag != steps.read_prev.outputs.prev }}
        run: |
          NEW_TAG="${{ steps.get_release.outputs.tag }}"
          # write the new tag (file in repo)
          echo "${NEW_TAG}" > .last_patchright_release
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_patchright_release
          git commit -m "ci: update last seen patchright release -> ${NEW_TAG}" || echo "no changes to commit"
          git push origin HEAD:${{ github.ref_name }}

      - name: No-op (no new release)
        if: ${{ steps.get_release.outputs.tag == steps.read_prev.outputs.prev }}
        run: echo "No new upstream Patchright release detected (tag ${{ steps.get_release.outputs.tag }})."
